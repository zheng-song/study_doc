## 摘要

- 针对 WindRiver公司的实时操作系统VxWorks，分析了系统结构以及内核的启动过程，USB驱动程序模型的结构以及功能，详细说明USB主机协议栈的实现原理。并且详细论述了VxWorks下驱动程序设计的原理以及步骤。同时设计了USB口转RS232驱动的实例。完成USB转RS232的驱动、
- ​





## 关键词

实时操作系统，驱动程序，通用串行总线，VxWorks，USB转RS232



## 引言











## 				VxWorks的数据同行模块

​	VxWorks下位机和上位机之间的数据通信方式一般有串行通信、并行同行、网络同行以及USB通信。一下对几种通信方式进行简单的概括：

| 通信方式  | 描述                                       | 特点                                |
| :---- | :--------------------------------------- | :-------------------------------- |
| 串行通信  | 通过计算机的串行接口负责把计算机之间的传输的串行信号转变为并行字符，以及反过来把并行字符转变为串行信号。采用异步接收/发送装置UART，接收和发送完全独立。 | 使用简单，传输距离长                        |
| 并行通信  | 通过计算机的并行口进行数据通信，8位并行的通信最高传输速率可达1Mbps     | 速度快，传输数据可靠，缺点是结构负载，距离近            |
| 网络通信  | 通过计算机的网络接口进行点对点通信(Point to Point),在TCP/IP协议的技术支持下，实现计算机之间的互相通信。 | 速度快，数据传输量大，便于组网                   |
| USB通信 | 通过计算机的USB接口进行通信                          | 支持即插即用和热插拔功能，缺点是编程复杂，需要编写专用的驱动程序。 |

经过我们对系统需求的分析，此处我们需要应用的场景是通信量不大，但是需要实时的进行上位机和下位机之间的数据传输，所以我们采用RS232串通信的方式，但是由于下位机的串口有限，项目提出方要求不能够占用串口，只有USB能够使用。于是我们决定采用USB口转RS232的方式来进行控制和数据传输。通信的协议默认设定为：波特率115200，8个数据位，1个停止位，无校验。



### VxWorks中串行通信的研究

​	在计算机系统通信应用当中，RS232串口是目前广泛使用的设备通信控制接口，在嵌入式实时操作系统中实现串口通信，可以大大提高系统的应用范围，提高系统获取信息的能力。在VxWorks当中，将I/O系统设计成为任何类型的设备提供一个简单、同一、独立于设备的接口。任何对于串口的操作都可以视为对一个文件的操作，而不必要了解串口设备或者是驱动程序实现的细节。

1. 串口的工作模式

VxWorks系统提供了两种串口的工作模式：RAW_MODE和LINE_MODE。

- LINE_MODE可以用来模拟一个终端，当缓冲区满或者是遇到回车符时才会将数据从串口送出。此外他还对一些字符进行转义，例如ctrl_S被解释为暂停输出，超级终端使用的就是这种方式。
- RAW_MODE模式下不对字符做出任何的解释，一旦有字符送入串口缓冲，串口读取程序就可以直接获取串口缓冲区中的数据，用来传输数据。

此处我们选择的方式是



2. 串口参数的选择

在进行串口数据通信值前，根据实际的系统需求必须对特定串口进行相关参数的配置。VxWorks实时操作系统通过I/O控制函数ioctl()对串口参数进行配置，其控制功能字(一部分)如下表所示:

| 功能字           | 功能              |
| ------------- | --------------- |
| FIOBAUDRATE   | 设置串口波特率         |
| FIOCANCEL     | 取消读写操作          |
| FIOFLUSH      | 清空输入缓冲和输出缓冲     |
| FIOGETNAME    | 得到设备文件名         |
| FIONREAD      | 得到输入缓冲区中未读取的字节数 |
| FIONWRITE     | 得到输出缓冲区中的字节数    |
| FIOSETOPTIONS | 设置设备选项字         |



3. 串口数据读写监测

为了提高数据接收的实时性，VxWorks实时操作系统可以通过select()函数的事件触发机制使得串口读写任务一直处于阻塞状态，当有数据到来的时候该任务会立即自动响应，从而提高系统数据传输的实时性。

​	函数select()通过对文件描述符集(结构体fd_set)相关的宏进行设置从而对串口进行操作，文件描述符集其实就是一个通过一个整型数组表示的一个"超长的"整型变量，变量的每一位表示一个文件描述符。所有对fd_set的操作都由VxWorks定义的宏进行。VxWorks提供的select()函数相关的宏定义如下:

| 宏        | 功能                 |
| -------- | ------------------ |
| FD_ZERO  | 所有位置零              |
| FD_SET   | 与之相应的文件描述符的位置1     |
| FD_CLR   | 清楚指定的位             |
| FD_ISSET | 若指定的位置1则返回1，否则返回0. |

以上的这些函数提供了对串口的有效控制，使得嵌入式VxWorks实时操作系统具有复杂的异步串口处理能力，从而给仿真系统的数据传输机制提供了强有力的保障。

