[TOC]

# 基于VxWorks的日志调试通道的设计与实现



##  摘要

​	数据传输是现代通讯过程中的一个重要环节，在数据的传输过程中，不仅仅要求数据传输的准确率要高，而且要求速度快，连接方便。传统的RS232串口通讯和并口通讯都存在传输速度低，扩展性性差、安装麻烦等缺点，而基于USB接口的数据传输系统能够较好的解决这些问题。目前USB接口以其传输速率高、即插即用、支持热插拔等优点，逐步成为PC机的标准接口。

​	本文中的数据传输系统采用了USB接口进行上位机与下位机之间的数据通讯。下位机采用的是VxWorks实时操作系统。

​	





​	关键词：嵌入式实时操作系统，设备驱动，USB口转串口，VxWorks，微内核





## 1. 绪论

​	当今，在嵌入式领域，嵌入式技术(Embedded Technology)已经成为了新的技术热点。嵌入式系统的最典型的特色是它同人们的日常生活紧密相关。小到MP3、PDA等微型数字化设备。大到信息家电、智能电视、车载GPS等形形色色运用了嵌入式技术的电子产品。目前各种新型嵌入式设备在数量上已经远远超过了通用计算机。在嵌入式设备发展的30多年的历史中，嵌入式技术从来没有像现在这样风靡，人类也从来没有像现在这样享受嵌入式技术带来的便利。

嵌入式系统被定义为：以应用为中心，以计算机技术为基础，软硬件可裁剪，适合于应用系统对功能、可靠性、成本、体积、功耗方面要求严格的专用计算机系统\cite{基于VxWorks的嵌入式实时系统设计}。嵌入式计算机在应用数量上远远超过了一般的通用型计算机，一台通用计算机的外部设备中就包含了5~10个嵌入式微处理器，键盘、鼠标、软驱、硬盘、显卡、显示器、网卡、调制解调器、声卡、打印机等等。他们均是由嵌入式处理器控制的。

​	目前国内外已有几十种商业化操作系统可以供选择，如VxWorks、pSOS、Palm OS、Neculeus、Windows CE和“女蜗Hopen”等。在我国，嵌入式操作系统可以分为两大类型：一类是自主版权的操作系统，另外一类是基于Linux的操作系统。自主版权的操作系统方面，国内的有“女蜗Hopen”操作系统、桑夏2000操作系统和DeltaOS操作系统等。近年来，嵌入式Linux进展较快。在我国，以Linux为基础的嵌入式操作系统比较活跃，其中中软Linux、红旗Linux、东方Linux是业界的代表。

​	随着后PC时代的到来，嵌入式应用将成为计算机应用的主流，同时，嵌入式应用同无线应用的结合使得嵌入式应用会具有更大的活力。应该指出，未来的几年嵌入式应用将能够更加灵活的和大型的网络计算平台互动，形成新的应用模式，甚至构架出新的计算机体系结构。因此，嵌入式应用和嵌入式软件将成为计算机工业中最具有活力的部分。	

​	实时系统根据响应的时间可以分为若实施系统、一般实时系统和强实时系统三种。弱实时系统在设计时的宗旨是使得各个任务运行的越快越好，但是没有严格的限定某一个任务必须要在多长的时间内完成；弱实时系统更多关注的是程序的运行结果的正确与否，以及系统安全性能等其他方面，对任务执行时间的要求相对来讲较为宽松，一般响应时间可以在数秒或者是更长。一般实时系统是弱实时系统和强实时系统的一种折中，它的响应时间可以在秒的数量级上，广泛应用于消费电子设备中。强实时系统则要求对各个任务不仅要保证执行过程和结果的正确性，同时海要保证在限定的时间内完成任务，响应时间通常要在毫秒级甚至是微秒的数量级上，这对涉及到医疗、安全、军事的软硬件系统来说是至关重要的。

​	VxWorks操作系统是美国WindRiver公司于1983年推出的一种嵌入式实时操作系统(RTOS)，是一个运行在目标机上的高性能、可裁剪的实时操作系统，是一个专门为嵌入式实时系统设计开发的操作系统，其具有良好的持续发展能力、高性能的内核以及友好的用户开发环境，为开发人员提供了高效的实时多任务调度、中断管理、实时的系统资源以及实时的任务间通信。在嵌入式实时操作系统领域当中占有一席之地。VxWorks支持X86、PowerPC、ARM等众多主流的处理器，且在各种CPU平台上提供了统一的编程接口和一致的运行环境。在军事、航空航天、工业控制、通信等高精尖以及实时性要求极高的领域当中，有着更加广泛而深入的应用。应用实例包括1997年火星表面登入的火星探测器、爱国者导弹、飞机导航、F-16、FA-18战斗机等。自从对我国的销售解禁之后，VxWorks也大量的应用于我国的军事、国防工业当中，通常在进行VxWorks应用程序的开发或者是将Linux下的应用程序移植到

​	实时操作系统需要对外来事件在限定的时间内作出反应，这类系统总是嵌入在一个大环境当中，即所谓的宿主系统当中，因此实时系统一般也是嵌入式系统(Embedded System)。实时系统可以分为实时事务处理和实时控制系统两大类，前者的大量工作是进行事务处理，对时间有一定的要求，响应时间一般不是很急，典型的如银行业务；而后者要求对外部事件作出快速的响应，否者会有灾难性后果，如飞行控制系统。

本章首先介绍了在VxWorks进行USB转串口的研究背景及现实意义。然后在根据技术的实现方式分类介绍当前国内外对USB通信设备类以及虚拟串口的研究状况，最后介绍了项目的设计与实现的安排。具体分为三小节来组织：

### 1.1 课题的背景以及意义。

1. 分析嵌入式实时操作系统VxWorks的特点和其市场定位。
2. USB接口和串口的特点及使用场景。
3. 提出为什么要在VxWorks这个操作系统上实现USB口转串口，并给出本课题的实际来源和市场需求。

### 1.2 国内外概况。

1. 介绍嵌入式实时操作系统VxWorks的主流使用场景，和其他通用操作系统相比有什么区别。

2. USB转串口的实现方式，目前在通用操作系统如Windows、Linux上USB口转串口接口的使用情况。目前在VxWorks上USB转串口的使用情况。

   由于USB设备是一种主从结构的设备，主机叫做Host，从机叫做Device,集线器通常也被当成一种特殊的设备来进行处理。但是USB的数据交换只能够在USB的HOST和Device之间发生，HOST和HOST之间，Device和Device之间是不能交换数据的。host和device之间所有的数据传输都只能由host发起，device只能够被动的负责应答。例如，在读取数据时，USB先发出一个读命令，设备收到该命令后，才会返回数据。在USB OTG当中一个设备可以在主机和从机之间进行切换，这样就可以实现设备与设备之间的连接，大大的增加了USB的使用范围，但这时依然没有脱离这种主从关系，两个设备之间必然有一个作为主机，另外一个作为从机。USB OTG增加了一种MINI USB接头，比普通的4线USB多了一个ID标识线，用来标明它是主机还是设备。

   ​	USB上的所有的数据传输都是由USB主机来启动的。通常，主机会创建一个管道——即一个连接到给定的外设上的特定端点。除了外设地址和端点号之外，管道还具有其他特性，如数据类型(控制、批量、中断或等时)，方向以及描述管道所需带宽的信息。管道创建之后，USB主机应用程序通过格式化IRP(I/O请求数据包)并将他们提交给USB驱动程序(称为Wind River USB主机堆栈中的USBD)来请求数据传输。

   ​	USB协议要求通信的双方必须一个是Host另外一个是device，一般的PC控制器都是EHCI/XHCI之类的，并且不支持OTG。



### 1.3 论文的主要内容和组织结构

1. 研究目标：在嵌入式实时操作系统VxWorks上实现一个满足特定要求的、规范的、高速的、实用的USB转串口驱动程序。

2. 难点以及主要的工作内容：

   2.1 阅读WindRiver公司提供的驱动开发手册，查阅VxWorks驱动开发的相关的中英文书籍，深入了解VxWorks的内部运行机制，理解驱动程序的原理，学习驱动开发的手段和步骤，同时熟悉WindRiver公司提供的开发工具。

   2.2 分析并试用现有的linux下的USB转串口驱动程序，对其中的通信设备类以及虚拟串口的实现技术进行研究。

   2.3 研究设计实现一个符合通信设备类中的抽象控制模型的虚拟串口驱动程序，并将其应用于项目当中。

3. 论文组织结构：首先介绍国内外的现有虚拟串口实现技术的研究现状和通用操作系统上实现虚拟串口的方法，然后分析VxWorks上的驱动程序的层次结构。基于VxWorks上的驱动程序的开发的理论知识，设计并完成USB转串口驱动的编写，完成驱动的测试，最后是VxWorks上的应用层的封装和接收端的设计。

## 2. 实时操作系统VxWorks

==本章节主要介绍实时操作系统VxWorks的相关应用背景知识，使得大家对其性能有一个比较感性的认识。然后介绍了该操作系统的内核组成以及运行原理，使得大家对其整体的框架有一个更深入的了解，因为驱动的开发需要对操作系统有足够的细致的理解。最后介绍了在VxWorks上USB协议栈的实现情况，为我们的USB口转串口驱动的实现做原理上的铺垫。==

### 2.1 概述

#### 2.1.1 实时操作系统

​	实时操作系统(Real Time Operation System)是整个实时系统的核心。POSIX1003.1标准为RTOS下了一个简单的定义：RTOS是能够在有限的响应时间内为应用提供所要求级别服务的操作系统\cite{Renard20081003}。这个系统能够对任何时间要求苛刻的事件服务，能够在正确的时间内做正确的事情。实时系统按照实时的效果可以分为软实时和硬实时，一个好的实时操作系统能够使你的系统时钟满足要实现的需求，即使在系统的负荷很重的情况下。

​	现代实时操作系统基于多任务和任务间通信的互补概念。多任务环境允许将实时应用程序构建为一组独立任务，每一个任务都有自己的执行线程和一组系统资源。任务间通信设施允许这些任务同步并进行协调其活动。在VxWorks中，任务间通信工具从快速信号量到消息队列，从管道到网络透明套接字。

​	实时系统的另外一个关键设施是硬件中断处理，因为中断处理时通知系统发生外部时间的常用机制。为了尽可能快地响应中断，VxWorks中的中断服务例程(ISR)运行自己的特定上下文中，这个上下文在任何其他的任务上下文之外\cite{Wind2003VxWorks}。

操作系统的核心是内核。内核控制着计算机系统上的所有硬件和软件资源，在必要的时候给应用程序分配硬件资源，并执行相应的操作命令。

​	内核的主要功能为以下的四种：

- 系统的内存管理：不仅可以管理服务器上的可用物理内存，还可以创建和管理虚拟内存。
- 软件程序管理：内核控制着系统上运行着的所有程序。
- 硬件设备管理：任何需要操作系统与之进行通信的设备都需要在内核的代码当中加入其驱动程序代码。驱动程序代码相当于应用程序和硬件设备间的中间人，允许内核和设备之间交换数据。
- 文件系统管理：不同于其他的一些操作系统，Linux内核支持通过不同类型的文件系统从硬盘当中读写数据。除了自有的诸多文件系统之外，Linux还支持从其他的操作系统(如windows)采用的文件系统中读写数据。内核必须在编译时就加入对所有可能用到的文件系统的支持。Linux内核采用虚拟文件系统(Virtual File System,VFS)作为和每一个文件系统交互的接口。这为Linux内核同任何类型文件系统通信提供了一个标准的接口，当每个文件系统都被挂载和使用时，VFS将信息都缓存在内存当中。

VxWorks是一种基于微内核技术的实时操作系统。

#### 2.1.2 VxWorks简介

​	VxWorks操作系统是美国WindRiver公司于1983年推出的一个运行在目标机上的高性能、可裁剪的实时操作系统(RTOS)，专门为嵌入式实时系统而设计开发，其具有良好的持续发展能力、高性能的内核以及友好的用户开发环境，为开发人员提供了高效的实时多任务调度、中断管理、实时的系统资源以及实时的任务间通信。并且拥有多达1800个功能强大的应用程序接口。

​	在嵌入式实时操作系统领域当中占有一席之地。VxWorks采用微内核设计，支持多种硬件环境，包括X86、PowerPC、ARM等众多主流的处理器，同时还支持RISC、DSP技术，且在各种CPU平台上提供了统一的编程接口和一致的运行环境。在军事、航空航天、工业控制、通信等高精尖以及实时性要求极高的领域当中，有着更加广泛而深入的应用。应用实例包括火星探测器、爱国者导弹、飞机导航、F-16、FA-18战斗机等。自从对我国的销售解禁之后，VxWorks也大量的应用于我国的军事、国防工业当中。

​	VxWorks的微内核Wind具有快速多任务切换、抢占式任务调度、任务间通信方式多样化的特点。高性能的操作系统核心wind支持所有的实时特性，其设计减少了系统开销，高效的任务管理保证了对外部事件快速、确定的反应。快速灵活的任务间和进程间通讯允许独立的任务在实时系统中与其行动相协调。

​	VxWorks实时操作系统由400多个相对独立的、短小精炼的目标模块组成，用户可以根据自己的实际需求选择适当的模板来裁剪和配置系统，这样可以有效的保证系统的安全性和可靠性。系统的连接器可以按照应用的需要自动链接一些目标模块。这样，通过目标模块之间的按需组合，可以得到许多满足功能需求的应用。此外，VxWorks支持广泛的工业标准，如POSIX1003.1b实时扩展、ANSIC(浮点支持)和TCP/IP网络协议等。这种广泛的协议支持在主机和目标机之间提供了无缝的工作环境，任务可以通过网络箱其他系统的主机存取文件，即远程文件存取，也支持远程的过程调用。这些标准也促进了多种不同产品之间的互通性，提升了可移植性。由于其高度的灵活性，用户能够很容易的对该操作系统进行重新定制或作适当的开发，以满足自己的实际应用。

1. **实时性设计：**实时性是指能够在限定时间内执行完规定的功能并能够对外部的事件做出响应的能力。实时性的强弱是以完成规定功能和作出响应时间的长短来衡量的。VxWorks的实时性做的相当好，而处于整个的实时性操作系统核心地位的就是高性能的微内核wind。这个微内核支持所有的实时性特征：快速的任务切换、中断支持、抢占式和时间片轮转调度等。微内核的设计使得系统的开销很小，进程调度、进程间通信、中断处理等系统公用程序精炼而有效，保证了对外部的事件快速、确定的反应。
2. **可裁剪性：** 用户使用操作系统时，并不是系统中的每一样部件都需要使用，例如图形显示以及一些设备驱动程序在某些嵌入式系统中往往并不使用。因此我们就可以将这部分的功能从系统中剔除。VxWorks有一个体积很小的微内核和一些可以根据需要进行定制的系统模块组成，有时候为了满足自己的需求，开发者也许要从100多个不同的选项中进行选择。许多独立的模块都是要在开发时要使用而在产品中却不在使用的。另外，TCP、UDP、套接口和标准Berkeley服务可以根据需要将其移出或移入网络协议栈。VxWorks的内核最小为8K，所占用的空间很小且不失实时性、多任务的系统的特征\cite{基于VxWorks的嵌入式实时系统设计操}。

![VxWorks系统结构](https://upload-images.jianshu.io/upload_images/6128001-5e0d977c081162a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 2.1.3 操作系统的主要功能

#### 2.1.4 操作系统的基本结构

​	VxWorks嵌入式实时操作系统的基本构成模块主要由以下几个部分：微内核wind；板级支持包BSP(Borad Support Package);网络系统(NetWorking Subsystem);文件系统(File Subsystem);I/O系统(I/O Subsystem);

### 2.2 微内核wind

==主要介绍VxWoks的核心的主要特点，包括高效的任务管理(提供无限数目的多任务，具有256个优先级，灵活的调度机制)；方便的任务间通信(提供多种信号量，网络通信以及共享内存等)；高度的可裁剪性(内核最小可以达到8K)。==

​	操作系统的内核提供系统运行的基本功能，如Unix系统的内核包括任务管理、中断处理、内存管理、设备驱动程序和文件系统等等，它是实现操作系统环境中其他子系统的基础。

​	在VxWorks中的模块组成如下：

![VxWorks的模块组成](https://upload-images.jianshu.io/upload_images/6128001-fcbe3352b6bce3fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

​	基于微内核的操作系统的设计思想与传统的整体式和层次式内核设计思想不同，它的核心只提供一个精简的系统功能集，从而使得系统内核非常小，称之为微内核。对于其他传统的内核功能，微内核系统通过内核虚拟机任务模型基础之上的服务协作来完成。和用户任务一样，系统服务任务之间的通信使用的是内核提供的统一的通信方式，从而使得系统具有模块化、结构清晰、可移植性强和可裁剪性好的特点。微内核的设计思想首先在CMU开发的MACH操作系统当中得到了成功的应用，并使得内核结构成为操作系统研究的热点\cite{Black1992Microkernel}

​	与传统的一体式结构和层次结构的操作系统相比，基于微内核的操作系统有很多的优点。归纳如下：

1. 接口统一：微内核的设计使得无论是系统服务还是用户服务，用户都可以使用相同的消息传递接口来申请，而不需要区别来对待。
2. 扩展性强：微内核的体系结构，使得一些新的服务可以以用户任务的形式加入到系统当中来。同时，对于同一个系统功能，还可以方便的提供几种互不冲突的服务形式供给用户选择，不需要对系统内核进行任何的修改。这样，一方面用户可以选择最适合自己的服务功能，另外一方面，系统更改造成的影响也只是局限在很小的范围。
3. 灵活性好：由于可扩展性好，不仅新的服务可以方便的加入到系统当中来，而且当前系统当中已经存在的服务也可以被裁剪从而生成一个规模较小，效率更高的系统。一个微内核系统可以看成是由一个小的内核附加一系列的服务组成。
4. 移植性强：在微内核系统当中，和处理器相关的代码都在微内核当中，因此进行系统移植时需要修改的代码量相对较少，而且其逻辑清晰的代码组织也使得移植比较容易。
5. 可靠性高：随着软件规模的增大，代码的可靠性越来越难以得到保证。采用微内核设计为代码的可靠性带来很大的好处。首先，小巧的微内核本身容易得到严格的测试。其次，它提供的数量有限编程接口减小了系统程序员的学习量。同时使得核外服务模块和其他系统部分的交互方式也得到有效的控制，减少副作用的可能，提高了代码的质量。
6. 分布式的支持能力：在分布式环境当中，客户机与服务器的通信方式与微内核系统中任务间的通信几乎一样。如果微内核系统提供了一种分布式环境当中全局唯一的任务标识方法，各任务就能和单击环境下一样访问远程的服务，而不需要知道服务所在的具体的位置。




#### 2.2.1 wind的多任务机制

​	VxWorks嵌入式实时操作系统的内核被称为wind，它所提供的功能包括：任务管理、事件和异步信号服务、信号量服务、消息队列服务、内存管理、中断服务程序、时钟管理和定时服务、异常处理等。

wind提供了基本的多任务环境，多任务构造出多线程并发执行的假象但实际上系统内核是根据某个调度算法交错执行的。Wind内核提供了基于优先级的抢占式调度作为它的缺省调度策略，同时也提供了轮转调度的机制。每一个任务都拥有各自的上下文环境，在进行任务切换时，任务的上下文保存在任务控制块(TCB)当中。

​	VxWorks操作系统中内存地址空间是一个非常重要的资源，其所有的代码在单一的公共地址空间内执行。为了建立独立的存储空间，每一个任务需要一个从虚拟地址向物理地址的映射机制。

​	Wind提供信号量作为任务之间的同步和互斥机制。在wind核中有几种类型的信号量，它们分别针对不同的应用需求；二进制信号量、计数信号量、互斥信号量和POSIX信号量。所有的这些信号量都是快速和高效的，它们除了被应用在开发设计过程中外，还会被广泛的应用在VxWorks的高层应用系统当中。对于进程间通信，wind核也提供了诸如消息队列、管道、套接字和信号等机制。

#### 2.2.2 任务状态的改变

​	操作系统中内核负责维护每一个任务的当前状态，若应用程序调用了内核程序，任务将会从一个状态改变为另外一个状态。任务在创建时处于挂起状态，必须要激活它才能够使其进入到就绪状态，激活过程相当快。另外一种方法是使用发起任务(spawning)的原语，此原语调用一个函数就能够完成创建并激活任务的过程。任务可以在任何一种状态下被删除。下图为wind内核状态的状态图:

![](https://upload-images.jianshu.io/upload_images/6128001-e10bc81aa6fe2182.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 2.2.3 Wind的任务调度

​	Wind内核有256种优先级，从0到255。0为最高优先级，255为最低优先级。在创建一个任务的时候，需要给任务分配一个优先级。调用函数taskPrioritySet()可以改变任务的优先级，这种动态的改变任务优先级的功能可以使的任务跟踪现实世界的有限关系变化。

**驱动程序支持的任务优先级**

​	所有的应用任务的优先级应该在100~250之间，但是驱动程序支持的任务(与中断服务程序关联的任务)优先级可以位于51 ~ 99之间，这些任务是很重要的。例如，某个任务从芯片内部复制数据失败，那么设备将不能获得数据。系统函数netTask()的优先级是50，所以用户使用任务的优先级应该分配在50以上，如果用户的任务出错，网络连接就会出现死机，并阻止Tornado工具进行调试。

**任务的异常处理：**

​	程序中代码或者是数据错误通常会导致诸如非法指令、总线或者是地址错误、除数为0等硬件异常。VxWorks操作系统的默认异常处理程序将会挂起导致异常的任务，并保存任务发生异常点的状态，内核和其他的任务将会继续执行而不会中断。

​	通过信号函数，任务能够激活他们自己的某种硬件异常处理程序。如果任务提供了一个异常信号处理程序，那么将不再使用上述默认异常处理程序。用户自定义的信号处理程序往往对于恢复严重破坏的事件非常有效。用来定义程序中恢复控制点的函数setjmp()以及在信号异常处理时恢复上下文的函数longjmp()，都是典型的自定义函数。



**共享代码和重入**

​	代码共享可以使得系统的效率更高，更容易维护。在VxWorks操作系统中I/O和驱动程序必须设计成是可重入的。但是应用程序的设计，仍然需要谨慎对待。对于缓冲I/O，建议对每一个任务使用文件指针缓冲器。由于VxWorks文件描述符表示全局的，所以在驱动级可能有来自于不同任务用流加载的缓冲。例如，包驱动程序能够混合不同任务的流，这是因为每一个包头部信息指明了目的地址。、

VxWorks中使用的重入技术有

- 动态堆栈变量
- 被信号量保护的全局和静态变量
- 任务变量

以上内容所描述的多任务间通信就是任务间通信功能。这些任务间通信功能协调多个独立任务间的活动。VxWorks操作系统提供了一套丰富的任务间通信机制，包括：

- 共享内存，数据的简单共享；
- 信号量，基本的互斥和同步；实现资源互斥的方法很多，不同之处仅仅在于互斥的范围。例如禁止中断、禁止抢占、以及信号量对资源的上锁等情况。
- Mutex和条件变量，使用POSIX接口时互斥与同步操作；
- 消息队列和管道，同一个CPU内任务间消息的传递；
- Sockets和远程程序调用，任务间透明的网络通信；
- 信号，用于处理异常。


### 2.3 集成开发环境Tornado

==主要介绍WindRiver公司为VxWorks提供的开发工具Tornado的核心组成部分、性能特点、使用方式等。==

​	Tornado是嵌入式实时领域里最新一代的开发调试环境，提供了高效明晰的图形化的实时应用开发平台，它包括一整套完整的面向嵌入式系统的开发和调试工具。Tornado采用的是主机—目标机的交叉开发模型，应用程序在主机的Windows环境下编译链接生成可执行文件，下载到目标机，通过主机上的目标服务器与目标机上的代理程序的通信完成对应用程序的调测、分析。这些工具包括C和C++远程级调试器、目标和工具管理、系统目标跟踪、内存使用分析和自动配置，所有工具都能够很方便的同时运行，很容易增加扩展和交互式开发。

​	典型的主机开发系统通常有比较大的RAM、硬盘空间、打印机以及其他外部设备，而典型的目标机系统只有仅能满足实时应用的资源，除此以外可能还有比较少量的用于测试和调试的额外资源。Tornado开发环境的基本优点是应用模块不需要链接到运行系统库。Tornado直接装载重定位的目标模块，荣国每个模块里的符号表来动态解析外部符号的引用，解析符号表是由运行在目标机上的目标服务器来完成的。Tornado在开发过程中会把目标模块的大小减到最小，这样可以缩短开发周期。主机端驻留的shell和调试器也能够调用和测试独立的应用程序或者是完整的任务。

​	Tornado是为开发VxWorks应用程序提供的集成开发环境，其中包含有工程管理软件，可以将用户自己的代码和VxWorks的核心有效的结合起来，可以按照用户的需要裁剪配置VxWorks内核；

​	Tornado开发系统包含有三个高度集成的部分：

- 运行在宿主机和目标机上的强有力的交叉开发工具和实用程序；

- 运行在目标机上的高性能、可裁剪的实时操作系统VxWorks；

- 连接宿主机和目标机的多种通信方式，如以太网，串口线，ICE或ROM仿真器等。

板级支持包BSP(Board Support Package)作为VxWorks系统的主要组成部分，对各种板子的硬件功能提供了同一的软件接口，它包括硬件初始化、中断的产生和处理、硬件时钟和计时器管理、局域和总线内存地址映射、内存分配等。每一个板级支持包包括一个ROM启动(Boot ROM)或其他启动机制。

​	Tornado主机集成开发环境中的主要工具为：

- 编辑器：源码编辑
- 工程管理器
- 编译器
- WindSh：一个驻留在主机端的命令行解释器，提供从主机端控制所有运行系统的接口
- CrossWind调试器：一个远程源码级的调试器，该调试器控制窗口综合了GDB命令行接口和WindSh工具。
- 浏览器：是一个系统对象的查看器，可以监视目标机的状态。
- WindView逻辑分析器：一个动态可视化工具，可以提供上下文切换的情况，事件和有关测量对象的信息。
- VxSim仿真器：用来模拟目标操作系统。

  ​

### 2.4 VxWorks上USB协议栈的实现

​	==主要介绍USB协议规定的USB的体系结构和框架，数据传输机制、传输类型等。然后介绍在VxWorks是如何实现USB协议栈的，分为哪几层来实现，以及我们重点介绍我们本次项目所需要接触的层次。==

​	USB是近年来应用在PC领域的较为新型的接口技术，是一些PC大厂商(Microsoft、Intel等)为了解决日益增加的PC外设与有限的主板插槽和端口之间的矛盾而定制的一种串行通信标准，从1995年在Comdex上展出以来至今已广泛地为各个PC厂家所支持。现在生产的PC几乎都配备了USB1.1和USB2.0接口，USB接口应用如此广泛是由其独特和实用的特性决定的\cite{}。	

**USB数据传输的优势**

实用USB	




## 3. 驱动程序开发

==本章主要描述在VxWorks下驱动程序开发的相关知识，以及在VxWorks下实现USB转串口驱动程序的实现过程。==

​	设备驱动程序是直接控制设备操作的那部分程序，也是设备上层的一个软件接口。设备驱动程序的功能是对I/O进行操作，实际上从软件的角度而言就是对I/O端口地址进行读写操作。只要系统访问设备就会调用驱动。驱动不能够自动执行，只能被系统或应用程序调用。

​	在嵌入式系统中调用设备驱动通常有三种方式：应用程序直接调用、应用程序通过操作系统内核调用、应用程序通过操作系统的扩展模块调用。如下图所示为应用程序调用设备驱动：

![image.png](https://upload-images.jianshu.io/upload_images/6128001-9df025cf4bf713ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 3.1 设备驱动概述

​	实时操作系统中通常需要使用各种外部设备，并且要求对外部事件作出快速准确的响应，否则可能会造成灾难性的后果。此外嵌入式系统使用的设备种类繁多，往往需要用户自行编写相应的设备驱动程序。因此设计一个灵活、高效、易于扩展的设备驱动模型对于嵌入式系统的应用至关重要。

​	驱动程序的根本目标是：当一个新的设备被加到系统当中时，不需要对操作系统的核心做任何的改变，同时允许操作系统可以较为容易地应用到不同的系统环境当中为了实现这个目的，一个驱动程序应该要具备以下的几个特点：

1. **可配置性：** 驱动程序可以根据实际的情况加载或者不加载，即根据操作系统的运行环境，管理的外部设备是否存在而决定是否在系统启动时加载相应的设备驱动，以免加载了不必要程序而多占用存储空间。这种可配置性也可以是动态可配置的，即系统可以动态加载或卸载相应的驱动程序，这就是所谓的即插即用。
2. **模块化：**为了适应外部设备的变化和各种应用的需要，模块化已经不仅仅是针对驱动软件的要求了。随着应用系统复杂性的增加，软件本省的结构也越来越庞大，为了减少局部的修改对整个系统造成影响，模块化也越来越重要，这一点在驱动程序中显得尤为重要。一个操作系统随着应用不同，管理的设备就会不同。若驱动程序的模块化不好，操作系统是不可能适应这种变化的。实际上，这种的模块化不仅仅是在程序的模块化上，同时更重要的是在数据结构的模块化上。
3. **可扩展性：** 若操作系统要做到少的改动甚至是不改动就可以应用到不同的系统当中，操作系统就必须要有把一个不可预知的设备加进来的功能。因为各个系统的设备是千差万别的，而且新的设备也正层出不穷，所以一个好的设备驱动的扩展能力不仅仅可以把现有的新设备加到系统当中，而且要着眼于未来可能出现的新设备。
4. **可重入性：** 可重入性是指在上次程序执行完之前，又可以重新进入的一种特性，这是在驱动程序设计中很重要又往往被忽视的一点。例如：在一个应用系统中，可能有相同的外围设备若干台，系统本身不可能也不应该为每一个相同的设备在内存空间当中都保留一个相同的程序副本。这样就是在浪费空间。这时，只需要有一个程序副本，就可以完成对这些相同设备的驱动。

  ​设备的驱动程序是直接控制设备操作的那一部分，也是设备上层的一个软件接口。设备驱动程序的功能是完成软件层对硬件层的访问，实际上从软件工程的角度而言就是介于软件和硬件之间实现软件层标准接口的程序。软件层访问硬件必须要通过调用驱动。所以驱动程序不能够自动执行只能够被系统或者是应用程序调用[^23][^24][^25][^26][^27][^28]。

  ​通常嵌入式系统对于设备驱动程序的调用通常有三种方式：直接调用、通过操作系统内核调用、通过操作系统的扩展模块进行调用。



**VxWorks中I/O设备的划分：**

1. 块设备：以“块”为单位对数据进行存取。系统通过设备表访问块设备，但是块设备上能够容纳文件系统。与字符设备的主要区别是内部数据管理的方式不同。块设备除了要给操作系统提供接口之外，还需要提供专门面向块设备的接口。块设备通常具有如下特点：
   - 在数据传输中传输固定大小的数据块
   - 可以随机访问块设备中所存放的数据块
2. 字符设备：能够像字节流一样被访问，在数据传输中以字符为单位进行传输，由字符设备驱动程序实现这种特性。字符设备驱动程序通常需要实现打开、关闭、读和写系统调用。像字符终端、串口、鼠标、打印机等就是字符设备的代表。字符设备可以通过文件方式(如/tyCo/0)来访问，它和普通的文件之间的唯一差别在于，对于普通文件的访问可以前后移动访问指针，而多数字符设备只能够顺序访问数据通道。字符设备通常具有如下的特点：
   - 在数据传输中可以传输任意大小的字符数据。像串口既可以一次传输一个字节，也可以通过数据流的方式来控制传输数据的大小。
   - 通常传输一组字符数据。
3. 网络设备：网络设备由网络子驱动程序负责发送和接受数据包，它与普通的I/O设备不同，没有对应的设备文件。所以应用程序和网络接口之间的数据通信不是基于标准的I/O系统接口，而是基于socket()、bind()、listen()、accept()、connect()等系统调用。  网络设备即通常所说的网卡。因为经过这一类设备的数据通常是与各种协议相关的，而这些协议是与什么样的网卡无关的。与硬件相关的部分的驱动程序是与协议栈挂接在一起的。这个公共接口，通常采用BSD的网络接口，但是使用BSD接口在开发设备驱动程序时就必须使上层协议栈了解设备驱动程序的数据结构，而上层协议栈往往是在设备驱动程序之前就已经开发好了的。这给在以后的网络驱动程序开发和移植带来了一定的困难。所以有的操作系统在上层协议与设备驱动程序之前增加一层，被称为多路开关。其作用有两个：第一是提供公共的数据结构以屏蔽协议栈与网络驱动程序之间的数据结构；第二是当系统当中支持多个网络设备时，完成上层协议栈和驱动程序之间的挂接透明，这一点的作用很类似于硬件的多路开关。但是这样做也带来了副作用，第一，使用接口数据复杂化；第二，实时性性能比BSD接口差。在设计中具体使用哪一种方法是依赖于实际系统的，所以有的操作系统提供了以上两种接口方式供用户选择。

以上三种设备的划分是很灵活的，但是同时又很难囊括所有的外设，因为这种分类方法实际上是在用抽象的数据结构描述不同的外设，而这些外设的特性以及相关协议的差异有时又很大，所以有的操作系统在提供I/O驱动软件接口的时候也提供一类用户自定义的设备，这个接口就是为了解决因为某些设备的特殊性而不能够被归入以上三类设备中的任何一类的一个特殊方法。

​	随着I/O设备的种类不断增加，其接口也越来越多样化，同时，硬件设备的不断推陈出新，使得从中提取出设备共性的难度也越来越大。这给I/O驱动软件的设计带来了很大的困难。然而，这个问题的解决并不能够仅仅依赖于软件开发人员，而是需要软硬件开发人员共同解决，也就是说在系统底层的开发中很难分清楚软/硬件的界限，USB(Universial Serial Bus)和IEEE1394的提出正是这样协同工作的结果，前者规范了低速度设备，后者则适用于高速设备。他们还试图规范外设的接口，这样无论对软/硬件开发人员，还是最终用户来说都是一个福音，作为开发人员可以提高软件的重用率，而用户则可以减少因为硬件接口不规范而引起的不必要开销。随着计算机技术的普及和发展，这种规范就显得更为重要\cite{aSurveyOfRTOS}。

**随着计算机应用领域越来越广泛，I/O设备的种类也越来越多样化，其接口也越来越复杂.如何能够最大限度地抽取I/O设备的共性，同时又饿能够适应I/O设备的多样性和灵活性，并在此基础上加以实现，是达到I/O驱动软件的可配置、模块化、可扩展和可重入的目标的关键。然而无论是抽取还是实现，都是依赖于应用系统的。从某种意义上来说，在操作系统的核心的实现方法和技术都相当成熟的今天，I/O驱动软件对于一个操作系统的应用范围和领域起着关键的作用。**

​	





#### 3.1.1 设备驱动的功能以及组成部分

​	操作系统中的驱动软件的性能会直接影响到操作系统的应用范围和效果，这一点可以从两个方面来说明。

1. 因为I/O驱动软件当中必须有中断服务程序且必须要运行在较高的优先级和特权级，这样I/O驱动软件就成了操作系统的内核密不可分的部分。
2. 为了使得操作系统更好的重用，适用于更多的应用系统，而不会应为被管理的设备的改变而更改操作系统，就必须要使I/O驱动软件尽可能少的依赖操作系统内核的其他部分。这样，I/O驱动软件又成为了操作系统中相对独立的部分。

正是由于I/O驱动软件具有这种特殊性，一个可扩展的I/O接口对于一个操作系统来说是至关重要的。如果操作系统不留有I/O扩展接口，一旦外设改变，开发人员就必须要重新修改操作系统，这样的开发费用和开发周期是难以估计的。

**VxWorks中设备驱动程序在系统当中的层次如下图所示：**

![image.png](https://upload-images.jianshu.io/upload_images/6128001-4ab775f6e18c13d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

​	VxWorks设备驱动程序是直接控制下层硬件设备的一个上层软件接口，同样对上层应用程序提供接口函数。

​	在VxWorks的BSP开发包中可能并没有提供开发者所使用的设备的驱动程序。这时就需要自己开发。

设备驱动通常包含六个主要的功能。

1. 对设备进行初始化：目的是使设备处于某种工作状态，以便用户程序访问该设备。譬如串口初始化包括设置串口波特率、数据位、奇偶校验位、停止位等。
2. 打开设备操作：实际上是查询用户指定的设备，并查看用户是否可以使用该设备。因为设备是共享资源，但设备正在被使用时，系统要对它进行保护，禁止其他任务对设备进行操作，直到设备资源被释放。
3. 关闭设备操作：关闭设备操作就是释放设备资源。任务对设备完成操作之后，必须要进行关闭设备操作，否则设备总是处于被占用状态，其他的任务无法使用。与打开设备操作相对应，有打开操作就应该有关闭操作。
4. 从设备上接收数据并提交给系统：即读操作，接收外部传输来的数据。接收数据采用的方式有查询方式、中断方式和DMA方式。
5. 把数据从主机上发送给设备：即写操作，把主机上的数据传送给外界。通常系统主动调用该操作进行数据发送，有时也会采用中断方式发送数据。
6. 对设备进行控制操作：使用设备过程中，有时根据应用的需要进行设备控制(例如改变设备的某个状态)，而控制操作就能够提供这种功能。

根据设备驱动程序的主要功能，设备驱动程序大致可以分为下面几个部分：

1. 设备驱动程序注册函数：驱动开发人员要编写一个函数把相关的驱动程序(打开、关闭、读写等)注册到系统设备驱动程序表中，以便系统对其管理和使用。
2. 设备驱动程序的卸载：当系统不再使用某一个设备时，为了节省资源的开销，需要从驱动程序表当中卸载该设备驱动程序并释放设备占用的资源。这些操作由设备驱动程序的卸载函数完成。
3. 设备的打开和关闭函数：完成设备的打开和关闭操作，注意这两个是成对出现的，有打开就要有关闭
4. 设备的读/写函数：主机与设备的通信主要由这个两个函数完成，主要功能是完成设备与CPU之间的数据传输操作。
5. 设备控制函数：对设备的操作当中，用户根据需要对设备进行控制。
6. 中断服务函数。该函数通常在对设备进行读写时使用，当设备上接收到数据或者数据发送结束时，通过触发硬件中断信号，向系统报告这一状态，系统便执行中断服务函数进行相应的处理。



#### 3.1.2 驱动程序管理表

#### 3.1.3 驱动程序管理步骤

**设备驱动程序错误处理:**

​	通常情况下，设备驱动程序形成产品之后，不应该在控制台上显示错误信息，而应该：

- 设置错误号(errno)和返回错误标志(典型为ERROR)；
- 让应用程序执行错误处理。

另外一个方面，当调试某个设备驱动程序时，如果出现错误则把错误信息显示在控制台上，这种做法在这个阶段是一种非常有效的方法，而且对于开发者而言错误的定位变得一目了然。

​	在VxWorks中，通常调用logMsg()函数来打印错误信息。这个函数的优点是既可以在任务中调用它也可以在中断服务程序中调用它。

### 3.2 USB转串口设备驱动程序开发

1. 需求分析，实现方法
2. CP2102芯片的相关知识，包括芯片的硬件电路的结构以及实现USB转串口的硬件实现方法。
3. 一个设备的情况下USB口转串口的实现方法。
4. 多个设备的情况下USB口转串口的实现方法。

## 4. 应用层程序接口封装

### 4.1task模式介绍和task模式下实现接口封装以及输入输出重定向的方法

1. 介绍VxWorks的task模式的特点
2. task模式下的接口封装以及输入输出重定向方法

### 4.2 RTP模式介绍和RTP模式下实现接口封装以及输入输出重定向的方法

1. VxWorks的RTP模式的特点
2. RTP模式下的接口封装以及输入输出重定向方法。


## 第五章 PC机接收及管理程序的设计

​	PC机的接收端采用Qt来进行设计，采用Qt的主要原因包块以下几个：

- 简单易学：Qt 封装的很好，几行代码就可以开发出一个简单的客户端，而 MFC 封装简陋，还需要了解 Windows API。
- 资料丰富：资料丰富能够成倍降低学习成本，否则你只能去看源码。
- 漂亮的界面：Qt 很容易做出漂亮的界面和炫酷的动画，而 MFC、WTL、wxWidgets 比较麻烦。
- 独立安装：Qt 程序最终会编译为本地代码，不需要其他库的支撑，而 Java 要安装虚拟机，C#要安装 .NET Framework。
- 跨平台：如果你的程序需要运行在多个平台下，同时又希望降低开发成本，Qt 几乎是必备的。

我们设计的主要的模块包块串口接收模块、日志显示界面模块、日志管理模块、项目树模块。

系统整体结构图如下：

![系统整体结构图](https://upload-images.jianshu.io/upload_images/6128001-e4ecd847de36df72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

PC机端的整体效果图如下：

![客户端运行截图](https://upload-images.jianshu.io/upload_images/6128001-38069a65aa771b48.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



- 第一节：串口接收模块的设计

  当用户打开串口之后，主窗口中的串口读取函数函数会对串口中的数据进行非阻塞的读取，并且按照我们设计的协议格式进行数据的解析、显示和存盘。

设计的协议格式如下：

```
\03\03<L=日志级别；PN=进程号；P=进程名；N=行号；T=时间>contents\04\04
```

- \03\03 : 表示的自定义协议格式的开始。当发现\03\03时就表示接下来的内容是按照我们定义的协议格式来解释的。
- <> : 尖括号内的内容表示的自定义协议数据包的头部。头部之后跟着的是数据包正文。
- \04\04：表示的是自定协议格式的结束。当发现\04\04时就表示已经读完了一条完整的自定义协议数据。
- 日志级别分为5种：
  1.  e：表示error。
  2.  w：表示warning。
  3.  i：表示info。
  4.  d：表示debug。
  5.  o：表示其他

之所以选择\02\02和\03\03这两个不可打印字符作为协议的开始符和结束符，而不是某些特殊的可打印字符，如%%、##等，是为了防止在协议的内容部分出现这些可打印字符，造成协议的解析混乱。\02在ASCII码中原本的作用是表示正文的开始。\03在ASCII中原本的作用是表示正文的结束。同时每一种日志级别的信息在日志显示框中会以不同的底色进行显示，以便进行区分。

​	对于使用我们提供的logWrite()接口函数来写入的调试信息，我们会按照自定义格式来进行解析。由于我们在下位机同时还提供了标准输出重定向的功能，所以当我们在下位机的应用程序当中直接使用printf()来进行输出的时候，接收端也可以进行接收并显示，但是不会有协议头部的那些信息，即日志级别、进程号、进程名、行号、时间等信息都为空，并且无法定位到这条信息所在的源代码的位置。所以建议使用我们提供的logWrite()函数来进行调试信息的输出，方便以后的定位和调试。

![串口读取和解析流程图](https://upload-images.jianshu.io/upload_images/6128001-8af62b42ca14c466.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

​	





- 第二节：日志显示界面的模块的设计



- 第三节：日志管理模块的设计


  日志管理模块主要提供的功能包括日志文件的读写、查找与定位等。


## 第六章 驱动程序的功能测试

​	本章的主要功能是完成整个程序的功能测试，包括在VxWorks下进行单独读测试、单独写测试，同时读写测试，验证整个程序的稳定性。

- 第一节：设备是否被添加到系统的管理表。
- 第二节：单独写测试，单独读功能测试。
- 第三节：同时读写测试。
- 第四节：task模式以及RTP模式下应用程序接口以及重定向功能测试。

测试的内容包括数据出错的概率，程序是否能够稳定运行等。



## 第七章 总结与展望





## 参考文献