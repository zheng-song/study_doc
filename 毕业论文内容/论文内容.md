[TOC]

# 基于VxWorks的日志调试通道的设计与实现





##  摘要

​	数据传输是现代通讯过程中的一个重要环节，在数据的传输过程中，不仅仅要求数据传输的准确率要高，而且要求速度快，连接方便。传统的RS232串口通讯和并口通讯都存在传输速度低，扩展性性差、安装麻烦等缺点，而基于USB接口的数据传输系统能够较好的解决这些问题。目前USB接口以其传输速率高、即插即用、支持热插拔等优点，逐步成为PC机的标准接口。

​	本文中的数据传输系统采用了USB接口进行上位机与下位机之间的数据通讯。下位机采用的是VxWorks实时操作系统。

​	





​	关键词：嵌入式实时操作系统，设备驱动，USB口转串口，VxWorks，微内核





## 1. 绪论

​	VxWorks操作系统是美国WindRiver公司于1983年推出的一种嵌入式实时操作系统(RTOS)，是一个运行在目标机上的高性能、可裁剪的实时操作系统，是一个专门为嵌入式实时系统设计开发的操作系统，其具有良好的持续发展能力、高性能的内核以及友好的用户开发环境，为开发人员提供了高效的实时多任务调度、中断管理、实时的系统资源以及实时的任务间通信。在嵌入式实时操作系统领域当中占有一席之地。VxWorks支持X86、PowerPC、ARM等众多主流的处理器，且在各种CPU平台上提供了统一的编程接口和一致的运行环境。在军事、航空航天、工业控制、通信等高精尖以及实时性要求极高的领域当中，有着更加广泛而深入的应用。应用实例包括1997年火星表面登入的火星探测器、爱国者导弹、飞机导航、F-16、FA-18战斗机等。自从对我国的销售解禁之后，VxWorks也大量的应用于我国的军事、国防工业当中，通常在进行VxWorks应用程序的开发或者是将Linux下的应用程序移植到

​	实时操作系统需要对外来事件在限定的时间内作出反应，这类系统总是嵌入在一个大环境当中，即所谓的宿主系统当中，因此实时系统一般也是嵌入式系统(Embedded System)。实时系统可以分为实时事务处理和实时控制系统两大类，前者的大量工作是进行事务处理，对时间有一定的要求，响应时间一般不是很急，典型的如银行业务；而后者要求对外部事件作出快速的响应，否者会有灾难性后果，如飞行控制系统。

本章首先介绍了在VxWorks进行USB转串口的研究背景及现实意义。然后在根据技术的实现方式分类介绍当前国内外对USB通信设备类以及虚拟串口的研究状况，最后介绍了项目的设计与实现的安排。具体分为三小节来组织：

### 1.1 课题的背景以及意义。

1. 分析嵌入式实时操作系统VxWorks的特点和其市场定位。
2. USB接口和串口的特点及使用场景。
3. 提出为什么要在VxWorks这个操作系统上实现USB口转串口，并给出本课题的实际来源和市场需求。

### 1.2 国内外概况。

1. 介绍嵌入式实时操作系统VxWorks的主流使用场景，和其他通用操作系统相比有什么区别。
2. USB转串口的实现方式，目前在通用操作系统如Windows、Linux上USB口转串口接口的使用情况。目前在VxWorks上USB转串口的使用情况。

### 1.3 论文的主要内容和组织结构

1. 研究目标：在嵌入式实时操作系统VxWorks上实现一个满足特定要求的、规范的、高速的、实用的USB转串口驱动程序。

2. 难点以及主要的工作内容：

   2.1 阅读WindRiver公司提供的驱动开发手册，查阅VxWorks驱动开发的相关的中英文书籍，深入了解VxWorks的内部运行机制，理解驱动程序的原理，学习驱动开发的手段和步骤，同时熟悉WindRiver公司提供的开发工具。

   2.2 分析并试用现有的linux下的USB转串口驱动程序，对其中的通信设备类以及虚拟串口的实现技术进行研究。

   2.3 研究设计实现一个符合通信设备类中的抽象控制模型的虚拟串口驱动程序，并将其应用于项目当中。

3. 论文组织结构：首先介绍国内外的现有虚拟串口实现技术的研究现状和通用操作系统上实现虚拟串口的方法，然后分析VxWorks上的驱动程序的层次结构。基于VxWorks上的驱动程序的开发的理论知识，设计并完成USB转串口驱动的编写，完成驱动的测试，最后是VxWorks上的应用层的封装和接收端的设计。

## 2. 实时操作系统VxWorks

==本章节主要介绍实时操作系统VxWorks的相关应用背景知识，使得大家对其性能有一个比较感性的认识。然后介绍了该操作系统的内核组成以及运行原理，使得大家对其整体的框架有一个更深入的了解，因为驱动的开发需要对操作系统有足够的细致的理解。最后介绍了在VxWorks上USB协议栈的实现情况，为我们的USB口转串口驱动的实现做原理上的铺垫。==

### 2.1 概述

#### 2.1.1 实时操作系统

​	实时操作系统(Real Time Operation System)是整个实时系统的核心。POSIX1003.1标准为RTOS下了一个简单的定义：RTOS是能够在有限的响应时间内为应用提供所要求级别服务的操作系统\cite{Renard20081003}。这个系统能够对任何时间要求苛刻的事件服务，能够在正确的时间内做正确的事情。实时系统按照实时的效果可以分为软实时和硬实时，一个好的实时操作系统能够使你的系统时钟满足要实现的需求，即使在系统的负荷很重的情况下。

​	现代实时操作系统基于多任务和任务间通信的互补概念。多任务环境允许将实时应用程序构建为一组独立任务，每一个任务都有自己的执行线程和一组系统资源。任务间通信设施允许这些任务同步并进行协调其活动。在VxWorks中，任务间通信工具从快速信号量到消息队列，从管道到网络透明套接字。

​	实时系统的另外一个关键设施是硬件中断处理，因为中断处理时通知系统发生外部时间的常用机制。为了尽可能快地响应中断，VxWorks中的中断服务例程(ISR)运行自己的特定上下文中，这个上下文在任何其他的任务上下文之外\cite{Wind2003VxWorks}。

操作系统的核心是内核。内核控制着计算机系统上的所有硬件和软件资源，在必要的时候给应用程序分配硬件资源，并执行相应的操作命令。

​	内核的主要功能为以下的四种：

- 系统的内存管理：不仅可以管理服务器上的可用物理内存，还可以创建和管理虚拟内存。
- 软件程序管理：内核控制着系统上运行着的所有程序。
- 硬件设备管理：任何需要操作系统与之进行通信的设备都需要在内核的代码当中加入其驱动程序代码。驱动程序代码相当于应用程序和硬件设备间的中间人，允许内核和设备之间交换数据。
- 文件系统管理：不同于其他的一些操作系统，Linux内核支持通过不同类型的文件系统从硬盘当中读写数据。除了自有的诸多文件系统之外，Linux还支持从其他的操作系统(如windows)采用的文件系统中读写数据。内核必须在编译时就加入对所有可能用到的文件系统的支持。Linux内核采用虚拟文件系统(Virtual File System,VFS)作为和每一个文件系统交互的接口。这为Linux内核同任何类型文件系统通信提供了一个标准的接口，当每个文件系统都被挂载和使用时，VFS将信息都缓存在内存当中。

VxWorks是一种基于微内核技术的实时操作系统。

#### 2.1.2 VxWorks简介

​	VxWorks操作系统是美国WindRiver公司于1983年推出的一个运行在目标机上的高性能、可裁剪的实时操作系统(RTOS)，专门为嵌入式实时系统而设计开发，其具有良好的持续发展能力、高性能的内核以及友好的用户开发环境，为开发人员提供了高效的实时多任务调度、中断管理、实时的系统资源以及实时的任务间通信。在嵌入式实时操作系统领域当中占有一席之地。VxWorks支持X86、PowerPC、ARM等众多主流的处理器，且在各种CPU平台上提供了统一的编程接口和一致的运行环境。在军事、航空航天、工业控制、通信等高精尖以及实时性要求极高的领域当中，有着更加广泛而深入的应用。应用实例包括1997年火星表面登入的火星探测器、爱国者导弹、飞机导航、F-16、FA-18战斗机等。自从对我国的销售解禁之后，VxWorks也大量的应用于我国的军事、国防工业当中。

1. **实时性设计：**实时性是指能够在限定时间内执行完规定的功能并能够对外部的事件做出响应的能力。实时性的强弱是以完成规定功能和作出响应时间的长短来衡量的。VxWorks的实时性做的相当好，而处于整个的实时性操作系统核心地位的就是高性能的微内核wind。这个微内核支持所有的实时性特征：快速的任务切换、中断支持、抢占式和时间片轮转调度等。微内核的设计使得系统的开销很小，进程调度、进程间通信、中断处理等系统公用程序精炼而有效，保证了对外部的事件快速、确定的反应。
2. **可裁剪性：** 用户使用操作系统时，并不是系统中的每一样部件都需要使用，例如图形显示以及一些设备驱动程序在某些嵌入式系统中往往并不使用。因此我们就可以将这部分的功能从系统中剔除。VxWorks有一个体积很小的微内核和一些可以根据需要进行定制的系统模块组成，有时候为了满足自己的需求，开发者也许要从100多个不同的选项中进行选择。许多独立的模块都是要在开发时要使用而在产品中却不在使用的。另外，TCP、UDP、套接口和标准Berkeley服务可以根据需要将其移出或移入网络协议栈。VxWorks的内核最小为8K，所占用的空间很小且不失实时性、多任务的系统的特征\cite{基于VxWorks的嵌入式实时系统设计操}。

#### 2.1.3 操作系统的主要功能

#### 2.1.4 操作系统的基本结构



### 2.1 微内核wind

==主要介绍VxWoks的核心的主要特点，包括高效的任务管理(提供无限数目的多任务，具有256个优先级，灵活的调度机制)；方便的任务间通信(提供多种信号量，网络通信以及共享内存等)；高度的可裁剪性(内核最小可以达到8K)。==

​	操作系统的内核提供系统运行的基本功能，如Unix系统的内核包括任务管理、中断处理、内存管理、设备驱动程序和文件系统等等，它是实现操作系统环境中其他子系统的基础。

​	基于微内核的操作系统的设计思想与传统的整体式和层次式内核设计思想不同，它的核心只提供一个精简的系统功能集，从而使得系统内核非常小，称之为微内核。对于其他传统的内核功能，微内核系统通过内核虚拟机任务模型基础之上的服务协作来完成。和用户任务一样，系统服务任务之间的通信使用的是内核提供的统一的通信方式，从而使得系统具有模块化、结构清晰、可移植性强和可裁剪性好的特点。微内核的设计思想首先在CMU开发的MACH操作系统当中得到了成功的应用，并使得内核结构成为操作系统研究的热点\cite{Black1992Microkernel}

​	与传统的一体式结构和层次结构的操作系统相比，基于微内核的操作系统有很多的优点。归纳如下：

1. 接口统一：微内核的设计使得无论是系统服务还是用户服务，用户都可以使用相同的消息传递接口来申请，而不需要区别来对待。
2. 扩展性强：微内核的体系结构，使得一些新的服务可以以用户任务的形式加入到系统当中来。同时，对于同一个系统功能，还可以方便的提供几种互不冲突的服务形式供给用户选择，不需要对系统内核进行任何的修改。这样，一方面用户可以选择最适合自己的服务功能，另外一方面，系统更改造成的影响也只是局限在很小的范围。
3. 灵活性好：由于可扩展性好，不仅新的服务可以方便的加入到系统当中来，而且当前系统当中已经存在的服务也可以被裁剪从而生成一个规模较小，效率更高的系统。一个微内核系统可以看成是由一个小的内核附加一系列的服务组成。
4. 移植性强：在微内核系统当中，和处理器相关的代码都在微内核当中，因此进行系统移植时需要修改的代码量相对较少，而且其逻辑清晰的代码组织也使得移植比较容易。
5. 可靠性高：随着软件规模的增大，代码的可靠性越来越难以得到保证。采用微内核设计为代码的可靠性带来很大的好处。首先，小巧的微内核本身容易得到严格的测试。其次，它提供的数量有限编程接口减小了系统程序员的学习量。同时使得核外服务模块和其他系统部分的交互方式也得到有效的控制，减少副作用的可能，提高了代码的质量。
6. 分布式的支持能力：在分布式环境当中，客户机与服务器的通信方式与微内核系统中任务间的通信几乎一样。如果微内核系统提供了一种分布式环境当中全局唯一的任务标识方法，各任务就能和单击环境下一样访问远程的服务，而不需要知道服务所在的具体的位置。





- 第三节：VxWorks开发环境

  ​	主要介绍WindRiver公司为VxWorks提供的开发工具Tornado的核心组成部分、性能特点、使用方式等。

- 第四节：VxWorks上USB协议栈的实现

  ​	主要介绍USB协议规定的USB的体系结构和框架，数据传输机制、传输类型等。然后介绍在VxWorks是如何实现USB协议栈的，分为哪几层来实现，以及我们重点介绍我们本次项目所需要接触的层次。



## 3. 驱动程序开发

==本章主要描述在VxWorks下驱动程序开发的相关知识，以及在VxWorks下实现USB转串口驱动程序的实现过程。==

### 3.1 设备驱动概述

​	实时操作系统中通常需要使用各种外部设备，并且要求对外部事件作出快速准确的响应，否则可能会造成灾难性的后果。此外嵌入式系统使用的设备种类繁多，往往需要用户自行编写相应的设备驱动程序。因此设计一个灵活、高效、易于扩展的设备驱动模型对于嵌入式系统的应用至关重要。

​	驱动程序的根本目标是：当一个新的设备被加到系统当中时，不需要对操作系统的核心做任何的改变，同时允许操作系统可以较为容易地应用到不同的系统环境当中为了实现这个目的，一个驱动程序应该要具备以下的几个特点：

1. **可配置性：** 驱动程序可以根据实际的情况加载或者不加载，即根据操作系统的运行环境，管理的外部设备是否存在而决定是否在系统启动时加载相应的设备驱动，以免加载了不必要程序而多占用存储空间。这种可配置性也可以是动态可配置的，即系统可以动态加载或卸载相应的驱动程序，这就是所谓的即插即用。
2. **模块化：**为了适应外部设备的变化和各种应用的需要，模块化已经不仅仅是针对驱动软件的要求了。随着应用系统复杂性的增加，软件本省的结构也越来越庞大，为了减少局部的修改对整个系统造成影响，模块化也越来越重要，这一点在驱动程序中显得尤为重要。一个操作系统随着应用不同，管理的设备就会不同。若驱动程序的模块化不好，操作系统是不可能适应这种变化的。实际上，这种的模块化不仅仅是在程序的模块化上，同时更重要的是在数据结构的模块化上。
3. **可扩展性：** 若操作系统要做到少的改动甚至是不改动就可以应用到不同的系统当中，操作系统就必须要有把一个不可预知的设备加进来的功能。因为各个系统的设备是千差万别的，而且新的设备也正层出不穷，所以一个好的设备驱动的扩展能力不仅仅可以把现有的新设备加到系统当中，而且要着眼于未来可能出现的新设备。
4. **可重入性：** 可重入性是指在上次程序执行完之前，又可以重新进入的一种特性，这是在驱动程序设计中很重要又往往被忽视的一点。例如：在一个应用系统中，可能有相同的外围设备若干台，系统本身不可能也不应该为每一个相同的设备在内存空间当中都保留一个相同的程序副本。这样就是在浪费空间。这时，只需要有一个程序副本，就可以完成对这些相同设备的驱动。

​	设备的驱动程序是直接控制设备操作的那一部分，也是设备上层的一个软件接口。设备驱动程序的功能是完成软件层对硬件层的访问，实际上从软件工程的角度而言就是介于软件和硬件之间实现软件层标准接口的程序。软件层访问硬件必须要通过调用驱动。所以驱动程序不能够自动执行只能够被系统或者是应用程序调用[^23][^24][^25][^26][^27][^28]。

​	通常嵌入式系统对于设备驱动程序的调用通常有三种方式：直接调用、通过操作系统内核调用、通过操作系统的扩展模块进行调用。

#### 3.1.1 设备驱动的功能以及组成部分

VxWorks中设备种类的划分：



​	操作系统中的驱动软件的性能会直接影响到操作系统的应用范围和效果，这一点可以从两个方面来说明。

1. 因为I/O驱动软件当中必须有中断服务程序且必须要运行在较高的优先级和特权级，这样I/O驱动软件就成了操作系统的内核密不可分的部分。
2. 为了使得操作系统更好的重用，适用于更多的应用系统，而不会应为被管理的设备的改变而更改操作系统，就必须要使I/O驱动软件尽可能少的依赖操作系统内核的其他部分。这样，I/O驱动软件又成为了操作系统中相对独立的部分。

正是由于I/O驱动软件具有这种特殊性，一个可扩展的I/O接口对于一个操作系统来说是至关重要的。如果操作系统不留有I/O扩展接口，一旦外设改变，开发人员就必须要重新修改操作系统，这样的开发费用和开发周期是难以估计的。

#### 3.1.2 驱动程序管理表

#### 3.1.3 驱动程序管理步骤



### 3.2 USB转串口设备驱动程序开发

1. 需求分析，实现方法
2. CP2102芯片的相关知识，包括芯片的硬件电路的结构以及实现USB转串口的硬件实现方法。
3. 一个设备的情况下USB口转串口的实现方法。
4. 多个设备的情况下USB口转串口的实现方法。

## 第四章 应用层程序接口封装

- 第一节：task模式介绍和task模式下实现接口封装以及输入输出重定向的方法
  1. 介绍VxWorks的task模式的特点
  2. task模式下的接口封装以及输入输出重定向方法


- 第二节：RTP模式介绍和RTP模式下实现接口封装以及输入输出重定向的方法
  1. VxWorks的RTP模式的特点
  2. RTP模式下的接口封装以及输入输出重定向方法。



## 第五章 PC机接收及管理程序的设计

​	PC机的接收端采用Qt来进行设计，采用Qt的主要原因包块以下几个：

- 简单易学：Qt 封装的很好，几行代码就可以开发出一个简单的客户端，而 MFC 封装简陋，还需要了解 Windows API。
- 资料丰富：资料丰富能够成倍降低学习成本，否则你只能去看源码。
- 漂亮的界面：Qt 很容易做出漂亮的界面和炫酷的动画，而 MFC、WTL、wxWidgets 比较麻烦。
- 独立安装：Qt 程序最终会编译为本地代码，不需要其他库的支撑，而 Java 要安装虚拟机，C#要安装 .NET Framework。
- 跨平台：如果你的程序需要运行在多个平台下，同时又希望降低开发成本，Qt 几乎是必备的。

我们设计的主要的模块包块串口接收模块、日志显示界面模块、日志管理模块、项目树模块。

系统整体结构图如下：

![系统整体结构图](https://upload-images.jianshu.io/upload_images/6128001-e4ecd847de36df72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

PC机端的整体效果图如下：

![客户端运行截图](https://upload-images.jianshu.io/upload_images/6128001-38069a65aa771b48.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



- 第一节：串口接收模块的设计

  当用户打开串口之后，主窗口中的串口读取函数函数会对串口中的数据进行非阻塞的读取，并且按照我们设计的协议格式进行数据的解析、显示和存盘。

设计的协议格式如下：

```
\03\03<L=日志级别；PN=进程号；P=进程名；N=行号；T=时间>contents\04\04
```

- \03\03 : 表示的自定义协议格式的开始。当发现\03\03时就表示接下来的内容是按照我们定义的协议格式来解释的。
- <> : 尖括号内的内容表示的自定义协议数据包的头部。头部之后跟着的是数据包正文。
- \04\04：表示的是自定协议格式的结束。当发现\04\04时就表示已经读完了一条完整的自定义协议数据。
- 日志级别分为5种：
  1.  e：表示error。
  2.  w：表示warning。
  3.  i：表示info。
  4.  d：表示debug。
  5.  o：表示其他

之所以选择\02\02和\03\03这两个不可打印字符作为协议的开始符和结束符，而不是某些特殊的可打印字符，如%%、##等，是为了防止在协议的内容部分出现这些可打印字符，造成协议的解析混乱。\02在ASCII码中原本的作用是表示正文的开始。\03在ASCII中原本的作用是表示正文的结束。同时每一种日志级别的信息在日志显示框中会以不同的底色进行显示，以便进行区分。

​	对于使用我们提供的logWrite()接口函数来写入的调试信息，我们会按照自定义格式来进行解析。由于我们在下位机同时还提供了标准输出重定向的功能，所以当我们在下位机的应用程序当中直接使用printf()来进行输出的时候，接收端也可以进行接收并显示，但是不会有协议头部的那些信息，即日志级别、进程号、进程名、行号、时间等信息都为空，并且无法定位到这条信息所在的源代码的位置。所以建议使用我们提供的logWrite()函数来进行调试信息的输出，方便以后的定位和调试。

![串口读取和解析流程图](https://upload-images.jianshu.io/upload_images/6128001-8af62b42ca14c466.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

​	





- 第二节：日志显示界面的模块的设计



- 第三节：日志管理模块的设计


  日志管理模块主要提供的功能包括日志文件的读写、查找与定位等。


## 第六章 驱动程序的功能测试

​	本章的主要功能是完成整个程序的功能测试，包括在VxWorks下进行单独读测试、单独写测试，同时读写测试，验证整个程序的稳定性。

- 第一节：设备是否被添加到系统的管理表。
- 第二节：单独写测试，单独读功能测试。
- 第三节：同时读写测试。
- 第四节：task模式以及RTP模式下应用程序接口以及重定向功能测试。

测试的内容包括数据出错的概率，程序是否能够稳定运行等。



## 第七章 总结与展望





## 参考文献