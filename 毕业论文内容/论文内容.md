[TOC]

# 基于VxWorks的日志调试通道的设计与实现









##  摘要

​	数据传输是现代通讯过程中的一个重要环节，在数据的传输过程中，不仅仅要求数据传输的准确率要高，而且要求速度快，连接方便。传统的RS232串口通讯和并口通讯都存在传输速度低，扩展性性差、安装麻烦等缺点，而基于USB接口的数据传输系统能够较好的解决这些问题。目前USB接口以其传输速率高、即插即用、支持热插拔等优点，逐步成为PC机的标准接口。

​	本文中的数据传输系统采用了USB接口进行上位机与下位机之间的数据通讯。下位机采用的是VxWorks实时操作系统。

​	





​	关键词：实时操作系统，设备驱动，USB口转串口，VxWorks，CP2103





## 1. 绪论

​	VxWorks操作系统是美国WindRiver公司于1983年推出的一种嵌入式实时操作系统(RTOS)，是一个运行在目标机上的高性能、可裁剪的实时操作系统，是一个专门为嵌入式实时系统设计开发的操作系统，其具有良好的持续发展能力、高性能的内核以及友好的用户开发环境，为开发人员提供了高效的实时多任务调度、中断管理、实时的系统资源以及实时的任务间通信。在嵌入式实时操作系统领域当中占有一席之地。VxWorks支持X86、PowerPC、ARM等众多主流的处理器，且在各种CPU平台上提供了统一的编程接口和一致的运行环境。在军事、航空航天、工业控制、通信等高精尖以及实时性要求极高的领域当中，有着更加广泛而深入的应用。应用实例包括1997年火星表面登入的火星探测器、爱国者导弹、飞机导航、F-16、FA-18战斗机等。自从对我国的销售解禁之后，VxWorks也大量的应用于我国的军事、国防工业当中，通常在进行VxWorks应用程序的开发或者是将Linux下的应用程序移植到

VxWorks是一款强实时性操作系统的代表，其高性能的内核，支持各种实时特征：任务间切换快、中断响应速度快、抢占式和时间片轮转调度等。并且减少了系统的资源消耗，保证了对外部事件响应迅速:





本章首先介绍了在VxWorks进行USB转串口的研究背景及现实意义。然后在根据技术的实现方式分类介绍当前国内外对USB通信设备类以及虚拟串口的研究状况，最后介绍了项目的设计与实现的安排。具体分为三小节来组织：

- 第一节：课题的背景以及意义。

  1. 分析嵌入式实时操作系统VxWorks的特点和其市场定位。
  2. USB接口和串口的特点及使用场景。
  3. 提出为什么要在VxWorks这个操作系统上实现USB口转串口，并给出本课题的实际来源和市场需求。

- 第二节：国内外概况。

  1. 介绍嵌入式实时操作系统VxWorks的主流使用场景，和其他通用操作系统相比有什么区别。
  2. USB转串口的实现方式，目前在通用操作系统如Windows、Linux上USB口转串口接口的使用情况。目前在VxWorks上USB转串口的使用情况。

- 第三节：论文的主要内容和组织结构，

  1. 研究目标：在嵌入式实时操作系统VxWorks上实现一个满足特定要求的、规范的、高速的、实用的USB转串口驱动程序。

  2. 难点以及主要的工作内容：

     2.1 阅读WindRiver公司提供的驱动开发手册，查阅VxWorks驱动开发的相关的中英文书籍，深入了解VxWorks的内部运行机制，理解驱动程序的原理，学习驱动开发的手段和步骤，同时熟悉WindRiver公司提供的开发工具。

     2.2 分析并试用现有的linux下的USB转串口驱动程序，对其中的通信设备类以及虚拟串口的实现技术进行研究。

     2.3 研究设计实现一个符合通信设备类中的抽象控制模型的虚拟串口驱动程序，并将其应用于项目当中。

  3. 论文组织结构：首先介绍国内外的现有虚拟串口实现技术的研究现状和通用操作系统上实现虚拟串口的方法，然后分析VxWorks上的驱动程序的层次结构。基于VxWorks上的驱动程序的开发的理论知识，设计并完成USB转串口驱动的编写，完成驱动的测试，最后是VxWorks上的应用层的封装和接收端的设计。

## 第二章 实时操作系统VxWorks

​	本章节主要介绍实时操作系统VxWorks的相关应用背景知识，使得大家对其性能有一个比较感性的认识。然后介绍了该操作系统的内核组成以及运行原理，使得大家对其整体的框架有一个更深入的了解，因为驱动的开发需要对操作系统有足够的细致的理解。最后介绍了在VxWorks上USB协议栈的实现情况，为我们的USB口转串口驱动的实现做原理上的铺垫。

​	操作系统的核心是内核。内核控制着计算机系统上的所有硬件和软件资源，在必要的时候给应用程序分配硬件资源，并执行相应的操作命令。

​	内核的主要功能为以下的四种：

- 系统的内存管理：不仅可以管理服务器上的可用物理内存，还可以创建和管理虚拟内存。
- 软件程序管理：内核控制着系统上运行着的所有程序。
- 硬件设备管理：任何需要操作系统与之进行通信的设备都需要在内核的代码当中加入其驱动程序代码。驱动程序代码相当于应用程序和硬件设备间的中间人，允许内核和设备之间交换数据。
- 文件系统管理：不同于其他的一些操作系统，Linux内核支持通过不同类型的文件系统从硬盘当中读写数据。除了自有的诸多文件系统之外，Linux还支持从其他的操作系统(如windows)采用的文件系统中读写数据。内核必须在编译时就加入对所有可能用到的文件系统的支持。Linux内核采用虚拟文件系统(Virtual File System,VFS)作为和每一个文件系统交互的接口。这为Linux内核同任何类型文件系统通信提供了一个标准的接口，当每个文件系统都被挂载和使用时，VFS将信息都缓存在内存当中。



- 第一节：概述

  1. 实时操作系统的概念
  2. VxWorks简介
  3. 操作系统的主要功能
  4. 操作系统的基本结构

- 第二节：微内核wind

  ​	主要介绍VxWoks的核心的主要特点，包括高效的任务管理(提供无限数目的多任务，具有256个优先级，灵活的调度机制)；方便的任务间通信(提供多种信号量，网络通信以及共享内存等)；高度的可裁剪性(内核最小可以达到8K)。

- 第三节：VxWorks开发环境

  ​	主要介绍WindRiver公司为VxWorks提供的开发工具Tornado的核心组成部分、性能特点、使用方式等。

- 第四节：VxWorks上USB协议栈的实现

  ​	主要介绍USB协议规定的USB的体系结构和框架，数据传输机制、传输类型等。然后介绍在VxWorks是如何实现USB协议栈的，分为哪几层来实现，以及我们重点介绍我们本次项目所需要接触的层次。



## 第三章：驱动程序开发

​	本章主要描述在VxWorks下驱动程序开发的相关知识，以及在VxWorks下实现USB转串口驱动程序的实现过程。

- 第一节：设备驱动概述
  1. 设备驱动的概念
  2. 设备驱动的功能以及组成部分
  3. 驱动程序管理表
  4. 驱动程序管理步骤
- 第二节：USB转串口设备驱动程序开发
  1. 需求分析，实现方法
  2. CP2102芯片的相关知识，包括芯片的硬件电路的结构以及实现USB转串口的硬件实现方法。
  3. 一个设备的情况下USB口转串口的实现方法。
  4. 多个设备的情况下USB口转串口的实现方法。

## 第四章 应用层程序接口封装

- 第一节：task模式介绍和task模式下实现接口封装以及输入输出重定向的方法
  1. 介绍VxWorks的task模式的特点
  2. task模式下的接口封装以及输入输出重定向方法


- 第二节：RTP模式介绍和RTP模式下实现接口封装以及输入输出重定向的方法
  1. VxWorks的RTP模式的特点
  2. RTP模式下的接口封装以及输入输出重定向方法。



## 第五章 PC机接收及管理程序的设计

​	PC机的接收端采用Qt来进行设计，采用Qt的主要原因包块以下几个：

- 简单易学：Qt 封装的很好，几行代码就可以开发出一个简单的客户端，而 MFC 封装简陋，还需要了解 Windows API。
- 资料丰富：资料丰富能够成倍降低学习成本，否则你只能去看源码。
- 漂亮的界面：Qt 很容易做出漂亮的界面和炫酷的动画，而 MFC、WTL、wxWidgets 比较麻烦。
- 独立安装：Qt 程序最终会编译为本地代码，不需要其他库的支撑，而 Java 要安装虚拟机，C#要安装 .NET Framework。
- 跨平台：如果你的程序需要运行在多个平台下，同时又希望降低开发成本，Qt 几乎是必备的。

我们设计的主要的模块包块串口接收模块、日志显示界面模块、日志管理模块、项目树模块。

系统整体结构图如下：

![系统整体结构图](https://upload-images.jianshu.io/upload_images/6128001-e4ecd847de36df72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

PC机端的整体效果图如下：

![客户端运行截图](https://upload-images.jianshu.io/upload_images/6128001-38069a65aa771b48.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



- 第一节：串口接收模块的设计

  当用户打开串口之后，主窗口中的串口读取函数函数会对串口中的数据进行非阻塞的读取，并且按照我们设计的协议格式进行数据的解析、显示和存盘。

设计的协议格式如下：

```
\03\03<L=日志级别；PN=进程号；P=进程名；N=行号；T=时间>contents\04\04
```

- \03\03 : 表示的自定义协议格式的开始。当发现\03\03时就表示接下来的内容是按照我们定义的协议格式来解释的。
- <> : 尖括号内的内容表示的自定义协议数据包的头部。头部之后跟着的是数据包正文。
- \04\04：表示的是自定协议格式的结束。当发现\04\04时就表示已经读完了一条完整的自定义协议数据。
- 日志级别分为5种：
  1.  e：表示error。
  2.  w：表示warning。
  3.  i：表示info。
  4.  d：表示debug。
  5.  o：表示其他

之所以选择\02\02和\03\03这两个不可打印字符作为协议的开始符和结束符，而不是某些特殊的可打印字符，如%%、##等，是为了防止在协议的内容部分出现这些可打印字符，造成协议的解析混乱。\02在ASCII码中原本的作用是表示正文的开始。\03在ASCII中原本的作用是表示正文的结束。同时每一种日志级别的信息在日志显示框中会以不同的底色进行显示，以便进行区分。

​	对于使用我们提供的logWrite()接口函数来写入的调试信息，我们会按照自定义格式来进行解析。由于我们在下位机同时还提供了标准输出重定向的功能，所以当我们在下位机的应用程序当中直接使用printf()来进行输出的时候，接收端也可以进行接收并显示，但是不会有协议头部的那些信息，即日志级别、进程号、进程名、行号、时间等信息都为空，并且无法定位到这条信息所在的源代码的位置。所以建议使用我们提供的logWrite()函数来进行调试信息的输出，方便以后的定位和调试。

![串口读取和解析流程图](https://upload-images.jianshu.io/upload_images/6128001-8af62b42ca14c466.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

​	





- 第二节：日志显示界面的模块的设计



- 第三节：日志管理模块的设计


  日志管理模块主要提供的功能包括日志文件的读写、查找与定位等。


## 第六章 驱动程序的功能测试

​	本章的主要功能是完成整个程序的功能测试，包括在VxWorks下进行单独读测试、单独写测试，同时读写测试，验证整个程序的稳定性。

- 第一节：设备是否被添加到系统的管理表。
- 第二节：单独写测试，单独读功能测试。
- 第三节：同时读写测试。
- 第四节：task模式以及RTP模式下应用程序接口以及重定向功能测试。

测试的内容包括数据出错的概率，程序是否能够稳定运行等。



## 第七章 总结与展望





## 参考文献